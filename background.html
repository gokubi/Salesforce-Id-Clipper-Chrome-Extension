<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
	<head>
		<script>

                BASIC_RE = /https\:\/\/.*\.salesforce\.com\/(\w{15})/ ;
                LINK_RE = /(https\:\/\/.*\.salesforce\.com\/(\w{15})/ ;
                VFORCE_RE = /https\:\/\/.*\.salesforce\.com\/apex\/.*id=(\w{15}).*/ ;

		// Called when the url of a tab changes.
		function checkForValidUrl(tabId, changeInfo, tab) {
			// If it's a salesforce database URL and contains an id
			if ((tab.url.indexOf('salesforce') > -1) && 
                             ((tab.url.match(BASIC_MATCH)[1] != null) || (tab.url.match(VFORCE_MATCH)[1] != null))) {
				// ... show the page action.
				chrome.pageAction.show(tabId);
				chrome.pageAction.setIcon({path: "clipper.png",
                               tabId: tab.id});
			}
		};

		// Listen for any changes to the URL of any tab.
		chrome.tabs.onUpdated.addListener(checkForValidUrl);
      
		// Called when the user clicks on the page action.
		chrome.pageAction.onClicked.addListener(function(tab) {
			bg = chrome.extension.getBackgroundPage();
			clipboardholder= bg.document.getElementById("clipboardholder");
			clipboardholder.style.display = "block";
			clipboardholder.value = tab.url.match(BASIC_RE)[1];;
                        if (!clipboardholder.value) clipboardholder.value = tab.url.match(VFORCE_RE)[1];
			clipboardholder.select();
			bg.document.execCommand("Copy");
			clipboardholder.style.display = "none";
			chrome.pageAction.setIcon({path: "clippered.png",
                               tabId: tab.id});
		});
		
		
		chrome.contextMenus.create(
  			{"title": "Copy Salesforce Id", "contexts" : ["link"],"onclick": onIdCopyClick}
  		)
  		chrome.contextMenus.create(
  			{"title": "Copy Clean Salesforce URL", "contexts" : ["link"],"onclick": onCleanCopyClick}
  		)
  		
  
	// copy Id only
	function onIdCopyClick(info, tab) {
		bg = chrome.extension.getBackgroundPage();
			clipboardholder= bg.document.getElementById("clipboardholder");
			clipboardholder.style.display = "block";
			clipboardholder.value = info.linkUrl.match(BASIC_RE)[1];;
                        if (!clipboardholder.value) clipboardholder.value = tab.url.match(VFORCE_RE)[1];
			clipboardholder.select();
			bg.document.execCommand("Copy");
			clipboardholder.style.display = "none";

	}
	
	// copy clean URL
	function onCleanCopyClick(info, tab) {
		bg = chrome.extension.getBackgroundPage();
			clipboardholder= bg.document.getElementById("clipboardholder");
			clipboardholder.style.display = "block";
			clipboardholder.value = info.linkUrl.match(LINK_RE)[1];;
                        if (!clipboardholder.value) clipboardholder.value = tab.url.match(VFORCE_RE)[1];
			clipboardholder.select();
			bg.document.execCommand("Copy");
			clipboardholder.style.display = "none";

	}
		
		</script>
	</head>
	<body>
		<textarea id="clipboardholder" style="display:none;"></textarea>
	</body>
</html>

